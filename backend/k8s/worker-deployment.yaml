apiVersion: apps/v1
kind: Deployment
metadata:
  name: cuenly-worker
  namespace: cuenly-backend
  labels:
    app: cuenly-worker
    tier: worker
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 1
  revisionHistoryLimit: 3
  progressDeadlineSeconds: 1200
  selector:
    matchLabels:
      app: cuenly-worker
      tier: worker
  template:
    metadata:
      labels:
        app: cuenly-worker
        tier: worker
    spec:
      terminationGracePeriodSeconds: 120
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: cuenly-worker
          image: ghcr.io/poravv/cuenly-app-backend:latest
          imagePullPolicy: Always
          command: ["python", "/app/worker.py"]
          resources:
            requests:
              memory: "512Mi"
              cpu: "100m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: REDIS_HOST
              value: cuenly-redis-service.cuenly-backend.svc.cluster.local
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_DB
              value: "0"
            - name: REDIS_SSL
              value: "0"
          envFrom:
            - secretRef:
                name: backend-env-secrets
            - secretRef:
                name: cuenly-backend-secrets
          readinessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "tr '\000' ' ' </proc/1/cmdline | grep -q 'worker.py'"
            initialDelaySeconds: 20
            periodSeconds: 20
            timeoutSeconds: 10
            failureThreshold: 3
          # Liveness probe: checks if the worker process is running
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "tr '\000' ' ' </proc/1/cmdline | grep -q 'worker.py'"
            initialDelaySeconds: 60
            periodSeconds: 60
            timeoutSeconds: 10
            failureThreshold: 5
          startupProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "tr '\000' ' ' </proc/1/cmdline | grep -q 'worker.py'"
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 30
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - "sleep 10"
