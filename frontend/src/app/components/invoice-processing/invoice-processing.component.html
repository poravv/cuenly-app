<div class="container-fluid mt-4 px-4 px-lg-5">
  <!-- Header con breadcrumb profesional -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center justify-content-between flex-wrap">
        <div>
          <nav aria-label="breadcrumb" class="mb-2">
            <ol class="breadcrumb mb-0">
              <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Inicio</a></li>
              <li class="breadcrumb-item active" aria-current="page">Procesamiento de Facturas</li>
            </ol>
          </nav>
          <h1 class="h2 mb-1 fw-bold d-flex align-items-center">
            <i class="bi bi-gear-wide-connected text-primary fs-4 me-3"></i>
            Procesamiento de Facturas
          </h1>
          <p class="text-muted mb-0">Gesti贸n y control del procesamiento autom谩tico e inteligente de facturas</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" (click)="getSystemStatus()"
            [disabled]="loading || jobStatus?.is_processing">
            <i class="bi bi-arrow-clockwise me-1"></i>
            Actualizar
          </button>
          <button class="btn btn-outline-secondary" routerLink="/profile/queue">
            <i class="bi bi-list-task me-1"></i>
            Cola de Procesos
          </button>
          <button class="btn btn-primary" (click)="openQuickSetup()">
            <i class="bi bi-envelope-plus me-1"></i>
            Conectar Correo Ahora
          </button>
          <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              <i class="bi bi-gear me-1"></i>
              Configuraci贸n
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" routerLink="/email-settings"><i class="bi bi-envelope me-2"></i>Correos</a>
              </li>
              <li><a class="dropdown-item" routerLink="/ayuda"><i class="bi bi-question-circle me-2"></i>Ayuda</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Setup r谩pido inline para evitar navegaci贸n extra -->
  <div class="row mb-4" *ngIf="showQuickSetup">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 pb-2">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
              <h5 class="mb-1 fw-bold d-flex align-items-center">
                <i class="bi bi-magic text-primary me-2"></i>
                Configuraci贸n R谩pida en 3 pasos
              </h5>
              <p class="text-muted small mb-0">
                1) Proveedor y credencial, 2) Nomenclaturas, 3) Guardar y procesar.
              </p>
            </div>
            <button class="btn btn-sm btn-outline-secondary" (click)="dismissQuickSetup()">
              <i class="bi bi-x-lg me-1"></i>Cerrar
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-lg-4">
              <label class="form-label fw-semibold">Proveedor</label>
              <select class="form-select" (change)="selectQuickProvider($any($event.target).value)">
                <option value="custom">Personalizado</option>
                <option value="gmail">Gmail</option>
                <option value="outlook">Outlook/Hotmail</option>
              </select>
            </div>
            <div class="col-lg-4">
              <label class="form-label fw-semibold">Servidor IMAP</label>
              <input class="form-control" [(ngModel)]="quickConfig.host" placeholder="imap.servidor.com">
            </div>
            <div class="col-lg-2">
              <label class="form-label fw-semibold">Puerto</label>
              <input type="number" class="form-control" [(ngModel)]="quickConfig.port">
            </div>
            <div class="col-lg-2 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="quick_ssl" [(ngModel)]="quickConfig.use_ssl">
                <label class="form-check-label" for="quick_ssl">SSL/TLS</label>
              </div>
            </div>

            <div class="col-lg-6">
              <label class="form-label fw-semibold">Usuario / Email</label>
              <input class="form-control" type="email" [(ngModel)]="quickConfig.username"
                placeholder="tu-correo@dominio.com">
            </div>
            <div class="col-lg-6">
              <label class="form-label fw-semibold">Contrase帽a</label>
              <input class="form-control" type="password" [(ngModel)]="quickConfig.password"
                placeholder="Contrase帽a o app password">
            </div>

            <div class="col-12">
              <label class="form-label fw-semibold">Nomenclaturas de asunto</label>
              <div class="row g-2">
                <div class="col-md-4" *ngFor="let term of quickConfig.search_terms; let i = index">
                  <div class="input-group">
                    <input class="form-control" [(ngModel)]="quickConfig.search_terms[i]" placeholder="ej: factura">
                    <button class="btn btn-outline-danger" type="button" (click)="removeQuickSearchTerm(i)"
                      [disabled]="(quickConfig.search_terms || []).length <= 1">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>
                </div>
              </div>
              <button class="btn btn-sm btn-outline-primary mt-2" type="button" (click)="addQuickSearchTerm()">
                <i class="bi bi-plus me-1"></i>Agregar t茅rmino
              </button>
            </div>

            <div class="col-12">
              <button class="btn btn-link p-0 text-decoration-none" type="button"
                (click)="quickAdvancedOpen = !quickAdvancedOpen">
                <i class="bi" [ngClass]="quickAdvancedOpen ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
                Configuraci贸n avanzada (sin贸nimos y fallback)
              </button>
            </div>

            <div class="col-12" *ngIf="quickAdvancedOpen">
              <div class="row g-3">
                <div class="col-lg-6">
                  <label class="form-label">Sin贸nimos por l铆nea</label>
                  <textarea class="form-control" rows="4" [(ngModel)]="quickSynonymsText"
                    placeholder="factura electronica: facturaci贸n, documento electr贸nico&#10;comprobante: cpe, comprobante de pago"></textarea>
                </div>
                <div class="col-lg-6">
                  <label class="form-label">Fallback</label>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="quick_fallback_sender"
                      [(ngModel)]="quickConfig.fallback_sender_match">
                    <label class="form-check-label" for="quick_fallback_sender">
                      Buscar en remitente si asunto no coincide
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="quick_fallback_attachment"
                      [(ngModel)]="quickConfig.fallback_attachment_match">
                    <label class="form-check-label" for="quick_fallback_attachment">
                      Buscar en nombre de adjunto si asunto no coincide
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="alert alert-danger border-0 mt-3 mb-0" *ngIf="quickError">
            {{ quickError }}
          </div>

          <div class="alert mt-3 mb-0" *ngIf="quickTestResult"
            [ngClass]="quickTestResult.success ? 'alert-success' : 'alert-danger'">
            {{ quickTestResult.message }}
          </div>

          <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn btn-outline-primary" type="button" (click)="testQuickSetup()" [disabled]="quickTesting">
              <span *ngIf="quickTesting" class="spinner-border spinner-border-sm me-1"></span>
              <i *ngIf="!quickTesting" class="bi bi-plug me-1"></i>
              Probar conexi贸n
            </button>
            <button class="btn btn-primary" type="button" (click)="saveQuickSetup(false)" [disabled]="quickSaving">
              <span *ngIf="quickSaving" class="spinner-border spinner-border-sm me-1"></span>
              Guardar configuraci贸n
            </button>
            <button class="btn btn-success" type="button" (click)="saveQuickSetup(true)" [disabled]="quickSaving">
              <span *ngIf="quickSaving" class="spinner-border spinner-border-sm me-1"></span>
              Guardar y procesar ahora
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs Principales con dise帽o profesional -->
  <div class="row g-4 mb-4" *ngIf="status">
    <div class="col-xl-3 col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <p class="text-muted fw-semibold mb-1">Cuentas Email</p>
              <h3 class="fw-bold mb-0">{{ status.email_configs_count || 0 }}</h3>
              <small [ngClass]="status.email_configured ? 'text-success' : 'text-warning'">
                <i class="bi bi-{{status.email_configured ? 'check-circle' : 'exclamation-triangle'}} me-1"></i>
                {{ status.email_configured ? 'Configurado' : 'Incompleto' }}
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6" *ngIf="jobStatus">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <p class="text-muted fw-semibold mb-1">Automatizaci贸n</p>
              <h3 class="fw-bold mb-0">{{ jobStatus.running ? 'ON' : 'OFF' }}</h3>
              <small [ngClass]="jobStatus.running ? 'text-success' : 'text-danger'">
                <i class="bi bi-{{jobStatus.running ? 'play-circle' : 'stop-circle'}} me-1"></i>
                {{ jobStatus.running ? 'Activa' : 'Inactiva' }}
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              <p class="text-muted fw-semibold mb-1">OpenAI</p>
              <h3 class="fw-bold mb-0">{{ status.openai_configured ? 'OK' : 'NO' }}</h3>
              <small [ngClass]="status.openai_configured ? 'text-success' : 'text-danger'">
                <i class="bi bi-{{status.openai_configured ? 'check-circle' : 'x-circle'}} me-1"></i>
                {{ status.openai_configured ? 'Configurado' : 'Requerido' }}
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Panel de Acciones R谩pidas -->
    <div class="col-xl-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0 pb-0">
          <div class="d-flex align-items-center">
            <i class="bi bi-lightning-charge text-primary fs-5 me-3"></i>
            <div>
              <h5 class="card-title mb-1 fw-bold">Acciones de Procesamiento</h5>
              <p class="text-muted mb-0 small">Gestiona tus procesos de extracci贸n de facturas</p>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="d-grid">
                <button class="btn btn-success btn-lg py-3"
                  [disabled]="loading || (jobStatus?.running === true) || jobStatus?.is_processing"
                  (click)="processEmails(true)">
                  <div class="d-flex align-items-center justify-content-center">
                    <i class="bi bi-envelope-check fs-6 me-2"></i>
                    <div class="text-start">
                      <div class="fw-bold">Procesar Correos</div>
                      <small class="opacity-75">Ejecutar extracci贸n ahora</small>
                      <!-- <small class="d-block mt-1 text-warning" *ngIf="jobStatus?.running">
                        <i class="bi bi-info-circle me-1"></i>Pausado por automatizaci贸n
                      </small> -->
                    </div>
                  </div>
                </button>
              </div>
            </div>

            <div class="col-md-4">
              <div class="d-grid">
                <a class="btn btn-outline-primary py-3" routerLink="/upload">
                  <i class="bi bi-file-earmark-text me-2"></i>
                  <div>Subir PDF / Imagen</div>
                </a>
              </div>
            </div>
            <div class="col-md-4">
              <div class="d-grid">
                <a class="btn btn-outline-primary py-3" routerLink="/upload-xml">
                  <i class="bi bi-file-code me-2"></i>
                  <div>Subir XML</div>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel de Estado del Proceso -->
    <div class="col-xl-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0 pb-0">
          <div class="d-flex align-items-center">
            <i class="bi bi-activity text-info fs-5 me-3"></i>
            <div>
              <h5 class="card-title mb-1 fw-bold">Estado del Proceso</h5>
              <p class="text-muted mb-0 small">Resultado de la 煤ltima ejecuci贸n</p>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- Loading State -->
          <div *ngIf="loading" class="text-center py-4">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">Procesando...</span>
            </div>
            <h6 class="fw-semibold">Procesando correos...</h6>
            <p class="text-muted small mb-0">Esto puede tomar unos momentos</p>
          </div>

          <!-- Success/Error State -->
          <div *ngIf="!loading && processingResult" class="text-center py-2">
            <div class="mb-3">
              <div [ngClass]="processingResult.success ? 'bg-success' : 'bg-danger'"
                class="bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center"
                style="width: 60px; height: 60px;">
                <i [ngClass]="processingResult.success ? 'bi-check-circle-fill text-success' : 'bi-exclamation-triangle-fill text-danger'"
                  class="fs-4"></i>
              </div>
            </div>
            <h6 class="fw-semibold mb-2" [ngClass]="processingResult.success ? 'text-success' : 'text-danger'">
              {{ processingResult.success ? 'Proceso Completado' : 'Error en Proceso' }}
            </h6>
            <p class="text-muted small mb-3">{{ processingResult.message }}</p>

            <div *ngIf="processingResult.invoice_count && processingResult.invoice_count > 0"
              class="bg-light rounded-3 p-3">
              <div class="fw-bold text-primary fs-5">{{ processingResult.invoice_count }}</div>
              <div class="small text-muted">Facturas procesadas</div>
            </div>
          </div>

          <!-- Error State - Trial Expirado -->
          <div *ngIf="!loading && !processingResult && error?.includes('')" class="alert alert-warning border-0 mx-3">
            <div class="d-flex align-items-start">
              <i class="bi bi-hourglass-split text-warning me-2 fs-5"></i>
              <div class="flex-grow-1">
                <h6 class="alert-heading mb-2">Per铆odo de Prueba Expirado</h6>
                <p class="mb-2">{{ (error || '').replace(' ', '') }}</p>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-warning" routerLink="/subscription">
                    <i class="bi bi-credit-card me-1"></i>Ver Planes
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" (click)="error = null">
                    <i class="bi bi-x me-1"></i>Cerrar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Error State General -->
          <div *ngIf="!loading && !processingResult && error && !error?.includes('')"
            class="alert alert-danger border-0 mx-3">
            <div class="d-flex align-items-start">
              <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>
              <div>
                <strong>Error:</strong> {{ error }}
                <div class="mt-2 small">
                  <button class="btn btn-sm btn-outline-danger" (click)="error = null">
                    <i class="bi bi-x me-1"></i>Cerrar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div *ngIf="!loading && !processingResult" class="text-center py-4">
            <div
              class="bg-light bg-opacity-50 rounded-circle d-inline-flex align-items-center justify-content-center mb-3"
              style="width: 60px; height: 60px;">
              <i class="bi bi-envelope-open text-muted fs-4"></i>
            </div>
            <h6 class="fw-semibold text-muted">Listo para procesar</h6>
            <p class="text-muted small mb-0">Haz clic en "Procesar Correos" para comenzar la extracci贸n</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Panel de Automatizaci贸n Avanzada -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 pb-0">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <i class="bi bi-robot text-warning fs-5 me-3"></i>
              <div>
                <h5 class="card-title mb-1 fw-bold">Automatizaci贸n Inteligente</h5>
                <p class="text-muted mb-0 small">Control avanzado del procesamiento autom谩tico</p>
              </div>
            </div>
            <div class="d-flex gap-2">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoRefreshSwitch" [(ngModel)]="autoRefresh"
                  (ngModelChange)="onAutoRefreshToggle($event)">
                <label class="form-check-label text-muted small" for="autoRefreshSwitch">Auto-actualizar</label>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div *ngIf="jobLoading" class="d-flex justify-content-center py-4">
            <div class="spinner-border text-warning" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>

          <div *ngIf="!jobLoading && jobStatus" class="row g-4">
            <!-- Estado y Controles -->
            <div class="col-lg-6">
              <div class="bg-light bg-opacity-50 rounded-3 p-4 h-100">
                <h6 class="fw-bold mb-3 d-flex align-items-center">
                  <i class="bi bi-gear me-2 text-primary"></i>
                  Estado y Controles
                </h6>

                <!-- Estado actual -->
                <div class="d-flex align-items-center justify-content-between p-3 bg-white rounded-3 mb-3">
                  <div>
                    <div class="fw-semibold">Estado del Sistema</div>
                    <small class="text-muted">Automatizaci贸n de procesos</small>
                  </div>
                  <div class="text-end">
                    <span class="badge px-3 py-2" [ngClass]="jobStatus.running ? 'bg-success' : 'bg-secondary'">
                      <i class="bi bi-{{jobStatus.running ? 'play-circle' : 'pause-circle'}} me-1"></i>
                      {{ jobStatus.running ? 'ACTIVO' : 'INACTIVO' }}
                    </span>
                  </div>
                </div>

                <!-- Informaci贸n temporal -->
                <div class="row g-3 mb-3">
                  <div class="col-6">
                    <div class="bg-white rounded-3 p-3 text-center">
                      <div class="text-primary fw-bold">{{ jobStatus.interval_minutes }}</div>
                      <small class="text-muted">Intervalo (min)</small>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="bg-white rounded-3 p-3 text-center">
                      <div class="text-info fw-bold">
                        {{ nextRunDisplay() }}
                      </div>
                      <div class="text-muted small" *ngIf="!jobStatus.running">Inactivo</div>
                      <small class="text-muted">Pr贸xima ejecuci贸n</small>
                    </div>
                  </div>
                </div>

                <!-- Controles principales -->
                <div class="d-grid gap-2">
                  <button *ngIf="!jobStatus.running" class="btn btn-success py-2"
                    [disabled]="jobLoading || jobStatus.is_processing" (click)="startJob()">
                    <i class="bi bi-play-fill me-2"></i>
                    Activar Automatizaci贸n
                  </button>
                  <button *ngIf="jobStatus.running" class="btn btn-danger py-2"
                    [disabled]="jobLoading || jobStatus.is_processing" (click)="stopJob()">
                    <i class="bi bi-stop-fill me-2"></i>
                    Detener Automatizaci贸n
                  </button>
                </div>
              </div>
            </div>

            <!-- Configuraci贸n Avanzada -->
            <div class="col-lg-6">
              <div class="bg-light bg-opacity-50 rounded-3 p-4 h-100">
                <h6 class="fw-bold mb-3 d-flex align-items-center">
                  <i class="bi bi-sliders me-2 text-info"></i>
                  Configuraci贸n Avanzada
                </h6>

                <!-- Intervalo de automatizaci贸n -->
                <div class="mb-3">
                  <label class="form-label fw-semibold small">Intervalo de Procesamiento</label>
                  <div class="input-group">
                    <select class="form-select" [ngModel]="jobIntervalInput"
                      (ngModelChange)="onJobIntervalChange($event)">
                      <option *ngFor="let opt of intervalOptions" [ngValue]="opt">{{ opt }} minutos</option>
                    </select>
                    <button class="btn btn-outline-primary" (click)="applyJobInterval()"
                      [disabled]="jobLoading || jobStatus.is_processing">
                      <i class="bi bi-check"></i>
                    </button>
                  </div>
                  <div class="form-text">Usa intervalos de 10, 15 o 20 minutos para evitar saturaci贸n.</div>
                </div>

                <!-- Frecuencia de actualizaci贸n del panel -->
                <div class="mb-3">
                  <label class="form-label fw-semibold small">Actualizaci贸n del Panel</label>
                  <select class="form-select" [ngModel]="autoRefreshIntervalMs"
                    (ngModelChange)="setAutoRefreshInterval($event)">
                    <option [ngValue]="15000">Cada 15 segundos</option>
                    <option [ngValue]="30000">Cada 30 segundos</option>
                    <option [ngValue]="60000">Cada 60 segundos</option>
                  </select>
                </div>

                <!-- Informaci贸n adicional -->
                <div class="bg-white rounded-3 p-3">
                  <div class="row text-center">
                    <div class="col-6 border-end">
                      <div class="small text-muted">ltima ejecuci贸n</div>
                      <div class="fw-semibold" *ngIf="jobStatus.last_run">
                        {{ formatParaguayDateTime(jobStatus.last_run) }}
                      </div>
                      <div class="text-muted" *ngIf="!jobStatus.last_run">Nunca</div>
                    </div>
                    <div class="col-6">
                      <div class="small text-muted">Estado</div>
                      <div class="fw-semibold" [ngClass]="jobStatus.running ? 'text-success' : 'text-secondary'">
                        {{ jobStatus.running ? 'Monitoreando' : 'En espera' }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Procesamiento por Rango de Fechas -->
          <div *ngIf="!jobLoading && jobStatus" class="row g-4 mt-2">
            <div class="col-12">
              <div class="bg-gradient rounded-3 p-4"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <h6 class="fw-bold mb-3 d-flex align-items-center text-white">
                  <i class="bi bi-calendar-range me-2"></i>
                  Procesar Rango de Fechas
                </h6>
                <p class="text-white-50 small mb-3">
                  Procesa correos de un per铆odo espec铆fico. til para reprocesar facturas antiguas.
                </p>

                <div class="row g-3 align-items-end">
                  <div class="col-md-4">
                    <label class="form-label text-white small fw-semibold">Fecha Inicio</label>
                    <input type="date" class="form-control" [(ngModel)]="dateRangeStart"
                      (ngModelChange)="onDateRangeStartChange($event)"
                      [disabled]="dateRangeLoading || jobStatus.is_processing">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label text-white small fw-semibold">Fecha Fin</label>
                    <input type="date" class="form-control" [(ngModel)]="dateRangeEnd"
                      (ngModelChange)="onDateRangeEndChange($event)"
                      [disabled]="dateRangeLoading || jobStatus.is_processing">
                  </div>
                  <div class="col-md-4">
                    <button class="btn btn-light w-100 fw-semibold" (click)="processDateRange()"
                      [disabled]="dateRangeLoading || !dateRangeStart || !dateRangeEnd || jobStatus.is_processing">
                      <span *ngIf="!dateRangeLoading">
                        <i class="bi bi-play-circle me-2"></i>Procesar Rango
                      </span>
                      <span *ngIf="dateRangeLoading">
                        <span class="spinner-border spinner-border-sm me-2"></span>Procesando...
                      </span>
                    </button>
                  </div>
                </div>

                <!-- Resultado del procesamiento -->
                <div *ngIf="dateRangeResult" class="alert alert-light mt-3 mb-0">
                  <div class="d-flex align-items-center justify-content-between">
                    <div>
                      <i class="bi bi-check-circle-fill text-success me-2"></i>
                      <strong *ngIf="dateRangeResult.job_id">Tarea encolada:</strong>
                      <span *ngIf="dateRangeResult.job_id">El proceso hist贸rico ha iniciado. Puedes ver el progreso en
                        <a routerLink="/profile/queue" class="alert-link">Cola de Eventos</a>.</span>
                      <strong *ngIf="!dateRangeResult.job_id">Procesamiento completado:</strong>
                      <span *ngIf="!dateRangeResult.job_id">{{ dateRangeResult.invoice_count || 0 }} facturas
                        procesadas</span>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" (click)="clearDateRangeResult()">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>
                </div>

                <!-- Error -->
                <div *ngIf="dateRangeError" class="alert alert-danger mt-3 mb-0">
                  <div class="d-flex align-items-center justify-content-between">
                    <div>
                      <i class="bi bi-exclamation-triangle-fill me-2"></i>
                      {{ dateRangeError }}
                    </div>
                    <button class="btn btn-sm btn-outline-danger" (click)="dateRangeError = null">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Error de automatizaci贸n - Trial Expirado -->
          <div *ngIf="jobError?.includes('trial') || jobError?.includes('Trial') || jobError?.includes('suscripci贸n')"
            class="alert alert-warning border-0 mt-3">
            <div class="d-flex align-items-start">
              <i class="bi bi-hourglass-split text-warning me-2 fs-5"></i>
              <div class="flex-grow-1">
                <h6 class="alert-heading mb-2">Automatizaci贸n No Disponible</h6>
                <p class="mb-2">{{ jobError }}</p>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-warning" routerLink="/subscription">
                    <i class="bi bi-credit-card me-1"></i>Ver Planes
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" (click)="jobError = null">
                    <i class="bi bi-x me-1"></i>Cerrar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Error de automatizaci贸n - General -->
          <div
            *ngIf="jobError && !(jobError?.includes('trial') || jobError?.includes('Trial') || jobError?.includes('suscripci贸n'))"
            class="alert alert-danger border-0 mt-3">
            <i class="bi bi-exclamation-triangle me-2"></i>
            {{ jobError }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ltimas facturas con dise帽o mejorado -->
  <div *ngIf="processingResult?.invoices && processingResult?.invoices!.length > 0" class="row mt-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 pb-0">
          <div class="d-flex align-items-center">
            <i class="bi bi-receipt text-info fs-5 me-3"></i>
            <div>
              <h5 class="card-title mb-1 fw-bold">ltimas Facturas Procesadas</h5>
              <p class="text-muted mb-0 small">{{ processingResult?.invoices?.length || 0 }} facturas en la 煤ltima
                ejecuci贸n</p>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th class="border-0 fw-bold">Fecha</th>
                  <th class="border-0 fw-bold">Emisor</th>
                  <th class="border-0 fw-bold">RUC</th>
                  <th class="border-0 fw-bold">Nro. Factura</th>
                  <th class="border-0 fw-bold text-end">Monto Total</th>
                  <th class="border-0 fw-bold text-end">IVA</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let invoice of processingResult?.invoices" class="border-bottom">
                  <td class="border-0">
                    <span class="fw-semibold">{{ invoice.fecha ? formatParaguayDate(invoice.fecha) : 'N/A' }}</span>
                  </td>
                  <td class="border-0">
                    <div class="fw-semibold text-truncate" style="max-width: 200px;" [title]="invoice.nombre_emisor">
                      {{ invoice.nombre_emisor || 'N/A' }}
                    </div>
                  </td>
                  <td class="border-0">
                    <code class="text-muted">{{ invoice.ruc_emisor || 'N/A' }}</code>
                  </td>
                  <td class="border-0">
                    <span class="badge bg-light text-dark">{{ invoice.numero_factura || 'N/A' }}</span>
                  </td>
                  <td class="border-0 text-end">
                    <span class="fw-bold text-success">{{ invoice.monto_total | currency:'':'symbol':'1.2-2' }}</span>
                  </td>
                  <td class="border-0 text-end">
                    <span class="text-muted">{{ invoice.iva | currency:'':'symbol':'1.2-2' }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .hover-shadow {
    transition: all 0.2s ease;
  }

  .hover-shadow:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
  }

  .transition {
    transition: all 0.2s ease;
  }
</style>
