<div class="modal-backdrop" *ngIf="isOpen" (click)="!saving && close()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <h3 class="modal-title">
        <i class="bi bi-envelope-at me-2"></i> 
        Configuración Rápida de Correo
      </h3>
      <button type="button" class="btn-close-custom" (click)="close()" [disabled]="saving" aria-label="Cerrar">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    
    <!-- Body -->
    <div class="modal-body">
      <p class="modal-description text-muted mb-4">
        Conecta tu cuenta de correo en segundos. Detectamos automáticamente tu proveedor.
      </p>

      <!-- Email Input -->
      <div class="form-group mb-3">
        <label for="email-input" class="form-label fw-semibold">
          <i class="bi bi-envelope me-1"></i>
          Tu correo electrónico
        </label>
        <input 
          id="email-input"
          type="email" 
          class="form-control form-control-lg"
          [(ngModel)]="config.username"
          (ngModelChange)="detectProvider($event)"
          placeholder="tu-correo@gmail.com"
          [disabled]="saving">
        <small class="form-text text-muted" *ngIf="!config.username || isValidEmail()">
          Detectamos automáticamente Gmail y Outlook
        </small>
        <small class="form-text text-danger" *ngIf="config.username && !isValidEmail()">
          Ingresa un correo válido para continuar.
        </small>
      </div>
      
      <!-- Password Input -->
      <div class="form-group mb-3">
        <label for="password-input" class="form-label fw-semibold">
          <i class="bi bi-key me-1"></i>
          Contraseña de aplicación
        </label>
        <input 
          id="password-input"
          type="password" 
          class="form-control form-control-lg"
          [(ngModel)]="config.password"
          placeholder="••••••••••••••••"
          [disabled]="saving">
        <small class="form-text" *ngIf="getHelpUrl(); else genericHelpLink">
          <a [href]="getHelpUrl()" target="_blank" rel="noopener" class="text-primary text-decoration-none">
            <i class="bi bi-question-circle me-1"></i>
            ¿Cómo crear una contraseña de aplicación?
          </a>
        </small>
        <ng-template #genericHelpLink>
          <small class="form-text text-muted">
            Si tu proveedor lo requiere, usa una contraseña de aplicación o credencial IMAP.
          </small>
        </ng-template>
      </div>

      <!-- Auto-detected Provider Info -->
      <div class="alert alert-info d-flex align-items-center" *ngIf="isProviderAutoDetected()">
        <i class="bi bi-check-circle-fill me-2 fs-5"></i>
        <div>
          <strong>Proveedor detectado:</strong> {{ config.host }} (IMAP seguro)
        </div>
      </div>

      <!-- Fallback para proveedor personalizado -->
      <div class="alert alert-warning d-flex align-items-center mb-3" *ngIf="isCustomProvider()">
        <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
        <div>
          <strong>Proveedor personalizado:</strong> completa servidor IMAP y puerto.
        </div>
      </div>

      <!-- Configuración IMAP -->
      <div class="row g-3 mb-3" *ngIf="config.username && (isCustomProvider() || isProviderAutoDetected())">
        <div class="col-md-8">
          <label for="host-input" class="form-label fw-semibold">
            <i class="bi bi-hdd-network me-1"></i>
            Servidor IMAP
          </label>
          <input
            id="host-input"
            type="text"
            class="form-control form-control-lg"
            [(ngModel)]="config.host"
            placeholder="imap.tu-proveedor.com"
            [readonly]="isProviderAutoDetected()"
            [disabled]="saving">
          <small class="form-text text-danger" *ngIf="config.host && !isValidHost()">
            El servidor IMAP no puede contener espacios.
          </small>
        </div>
        <div class="col-md-4">
          <label for="port-input" class="form-label fw-semibold">Puerto</label>
          <input
            id="port-input"
            type="number"
            min="1"
            max="65535"
            class="form-control form-control-lg"
            [(ngModel)]="config.port"
            [readonly]="isProviderAutoDetected()"
            [disabled]="saving">
          <small class="form-text text-danger" *ngIf="config.port && !isValidPort()">
            Puerto inválido.
          </small>
        </div>
        <div class="col-12">
          <div class="form-check ssl-toggle">
            <input
              id="ssl-input"
              type="checkbox"
              class="form-check-input"
              [(ngModel)]="config.use_ssl"
              [disabled]="saving">
            <label class="form-check-label" for="ssl-input">
              Usar conexión SSL/TLS
            </label>
          </div>
        </div>
      </div>

      <!-- Help Text -->
      <div class="alert alert-light border">
        <h6 class="alert-heading mb-2">
          <i class="bi bi-lightbulb text-warning me-1"></i>
          Consejos rápidos
        </h6>
        <ul class="mb-0 small ps-3">
          <li>Usa una <strong>contraseña de aplicación</strong>, no tu contraseña normal</li>
          <li>Gmail y Outlook se configuran automáticamente</li>
          <li>Para otros proveedores, usa servidor IMAP + puerto (ej: 993 con SSL)</li>
          <li>Procesaremos tus correos inmediatamente después de guardar</li>
        </ul>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="modal-footer">
      <button 
        type="button"
        class="btn btn-outline-secondary" 
        (click)="close()"
        [disabled]="saving">
        <i class="bi bi-x-circle me-1"></i>
        Cancelar
      </button>
      <button 
        type="button"
        class="btn btn-primary btn-lg shadow-primary"
        (click)="saveAndProcess()"
        [disabled]="!isValid() || saving">
        <span *ngIf="!saving">
          <i class="bi bi-lightning-charge-fill me-2"></i>
          Guardar y Procesar
        </span>
        <span *ngIf="saving">
          <span class="spinner-border spinner-border-sm me-2"></span>
          Guardando...
        </span>
      </button>
    </div>
  </div>
</div>
