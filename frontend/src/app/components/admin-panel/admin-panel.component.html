<div class="admin-panel">
  <div class="admin-header">
    <h1 class="admin-title">
      <i class="bi bi-shield-check"></i>
      Panel de Administración
    </h1>
    <p class="admin-subtitle">Gestión de usuarios y estadísticas del sistema</p>
  </div>

  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando datos del sistema...</p>
  </div>

  <div *ngIf="!loading" class="admin-content">

    <div class="tab-navigation">
      <button class="tab-button" [class.active]="activeTab === 'stats'" (click)="setActiveTab('stats')">
        <i class="bi bi-graph-up"></i>
        Estadísticas
      </button>
      <button class="tab-button" [class.active]="activeTab === 'users'" (click)="setActiveTab('users')">
        <i class="bi bi-people"></i>
        Usuarios
      </button>
      <button class="tab-button" [class.active]="activeTab === 'plans'" (click)="setActiveTab('plans')">
        <i class="bi bi-credit-card"></i>
        Planes
      </button>
      <button class="tab-button" [class.active]="activeTab === 'subscriptions'" (click)="setActiveTab('subscriptions')">
        <i class="bi bi-arrow-repeat"></i>
        Suscripciones
      </button>
      <button class="tab-button" [class.active]="activeTab === 'ai-limits'" (click)="setActiveTab('ai-limits')">
        <i class="bi bi-robot"></i>
        Límites IA
      </button>
    </div>

    <div *ngIf="activeTab === 'stats'" class="tab-content">

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon users">
            <i class="bi bi-people"></i>
          </div>
          <div class="stat-content">
            <h3>{{formatNumber(userStats.total_users)}}</h3>
            <p>Total Usuarios</p>
            <small class="text-muted">{{formatNumber(userStats.active_users)}} activos · {{formatNumber(userStats.trial_users)}} trial</small>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon invoices">
            <i class="bi bi-receipt"></i>
          </div>
          <div class="stat-content">
            <h3>{{formatNumber(invoiceStats.total_invoices)}}</h3>
            <p>Total Facturas</p>
            <small class="text-muted">{{formatNumber(invoiceStats.total_items)}} ítems</small>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(34,197,94,0.12); color: #16a34a;">
            <i class="bi bi-file-earmark-code"></i>
          </div>
          <div class="stat-content">
            <h3>{{formatNumber(invoiceStats.source_totals?.xml_nativo || 0)}}</h3>
            <p>XML Nativo</p>
            <small class="text-muted">{{getSourcePercent(invoiceStats.source_totals?.xml_nativo || 0)}}% del total</small>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon" style="background: rgba(139,92,246,0.12); color: #7c3aed;">
            <i class="bi bi-robot"></i>
          </div>
          <div class="stat-content">
            <h3>{{formatNumber(invoiceStats.source_totals?.openai_vision || 0)}}</h3>
            <p>OpenAI Vision</p>
            <small class="text-muted">{{getSourcePercent(invoiceStats.source_totals?.openai_vision || 0)}}% del total</small>
          </div>
        </div>
      </div>

      <!-- Cola RQ en tiempo real -->
      <div class="rq-stats-row" *ngIf="queueStats || loadingQueueStats">
        <div class="rq-card" *ngIf="loadingQueueStats">
          <span class="spinner-border spinner-border-sm text-muted"></span>
          <span class="ms-2 text-muted small">Cargando colas...</span>
        </div>
        <ng-container *ngIf="!loadingQueueStats && queueStats">
          <div class="rq-card">
            <i class="bi bi-cpu text-primary"></i>
            <div>
              <strong>{{queueStats.workers_online}}</strong>
              <span class="rq-label">Workers activos</span>
            </div>
          </div>
          <div class="rq-card">
            <i class="bi bi-hourglass-split text-warning"></i>
            <div>
              <strong>{{formatNumber(getTotalQueued())}}</strong>
              <span class="rq-label">En cola</span>
            </div>
          </div>
          <div class="rq-card" [class.rq-card--alert]="getTotalFailed() > 0">
            <i class="bi bi-exclamation-circle" [class.text-danger]="getTotalFailed() > 0" [class.text-muted]="getTotalFailed() === 0"></i>
            <div>
              <strong [class.text-danger]="getTotalFailed() > 0">{{formatNumber(getTotalFailed())}}</strong>
              <span class="rq-label">Fallidos</span>
            </div>
          </div>
          <div class="rq-card rq-detail">
            <span class="rq-q-name">High</span>
            <span class="rq-q-val">{{queueStats.queues.high?.queued || 0}} pendientes</span>
            <span class="rq-q-name ms-2">Default</span>
            <span class="rq-q-val">{{queueStats.queues.default?.queued || 0}} pendientes</span>
            <span class="rq-q-name ms-2">Low</span>
            <span class="rq-q-val">{{queueStats.queues.low?.queued || 0}} pendientes</span>
          </div>
        </ng-container>
      </div>

      <div class="charts-section">
        <div class="chart-container">
          <h3>Facturas por Mes (Últimos 6 meses)</h3>
          <div class="chart-content">
            <div *ngIf="getRecentMonths().length === 0" class="no-data">
              No hay datos disponibles
            </div>
            <div *ngIf="getRecentMonths().length > 0" class="simple-chart">
              <div *ngFor="let month of getRecentMonths()" class="chart-bar"
                [title]="month.month + ': ' + month.count + ' facturas (XML: ' + month.xml_nativo + ' | IA: ' + month.openai_vision + ')'">
                <div class="bar-label">{{month.month}}</div>
                <div class="bar-container">
                  <div class="bar" [style.height.%]="(month.count / getMaxMonthCount()) * 100">
                  </div>
                </div>
                <div class="bar-value">{{month.count}}</div>
                <div class="bar-source-mini">
                  <span class="src-xml" [title]="'XML: ' + month.xml_nativo">{{month.xml_nativo}}</span>
                  <span class="src-ai" [title]="'IA: ' + month.openai_vision">{{month.openai_vision}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="chart-container">
          <h3>Top 5 Usuarios (Facturas procesadas)</h3>
          <div class="chart-content">
            <div *ngIf="getTopUsers().length === 0" class="no-data">
              No hay datos disponibles
            </div>
            <div *ngIf="getTopUsers().length > 0" class="user-stats-list">
              <div *ngFor="let user of getTopUsers()" class="user-stat-item">
                <div class="user-email">{{user.email}}</div>
                <div class="user-stats">
                  <span class="stat-value">{{formatNumber(user.count)}} facturas</span>
                  <span class="stat-total">{{formatCurrency(user.total)}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="advanced-stats-section">
        <h3>Estadísticas Filtradas</h3>

        <div class="filters-form">
          <div class="filter-row">
            <div class="filter-group">
              <label>Fecha Inicio:</label>
              <input type="date" [(ngModel)]="statsFilters.start_date" class="form-control">
            </div>

            <div class="filter-group">
              <label>Fecha Fin:</label>
              <input type="date" [(ngModel)]="statsFilters.end_date" class="form-control">
            </div>

            <div class="filter-group">
              <label>Usuario:</label>
              <select [(ngModel)]="statsFilters.user_email" class="form-control">
                <option value="">Todos los usuarios</option>
                <option *ngFor="let user of users; trackBy: trackByEmail" [value]="user.email">
                  {{user.name || user.email}}
                </option>
              </select>
            </div>

            <div class="filter-group">
              <button class="btn btn-primary" (click)="loadFilteredStats()" [disabled]="loadingFilteredStats">
                <i class="bi bi-search"></i>
                Filtrar
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="loadingFilteredStats" class="loading-stats">
          <div class="spinner-small"></div>
          <span>Cargando estadísticas filtradas...</span>
        </div>

        <div *ngIf="filteredStats && !loadingFilteredStats" class="filtered-stats-content">
          <div class="filtered-summary">
            <div class="summary-card">
              <h4>{{formatNumber(filteredStats.stats.total_invoices)}}</h4>
              <p>Facturas</p>
            </div>
            <div class="summary-card">
              <h4>{{formatCurrency(filteredStats.stats.total_amount)}}</h4>
              <p>Monto Total</p>
            </div>
            <div class="summary-card">
              <h4>{{formatCurrency(filteredStats.stats.avg_amount)}}</h4>
              <p>Promedio</p>
            </div>
          </div>

          <div *ngIf="filteredStats.stats.daily_breakdown.length > 0" class="chart-container">
            <h4>Distribución Diaria</h4>
            <div class="daily-chart">
              <div *ngFor="let day of filteredStats.stats.daily_breakdown" class="daily-bar">
                <div class="bar-container">
                  <div class="bar" [style.height.%]="getBarHeight(day.count, getMaxDailyCount())">
                  </div>
                </div>
                <div class="bar-label">{{formatShortDate(day._id)}}</div>
                <div class="bar-value">{{day.count}}</div>
              </div>
            </div>
          </div>

          <div *ngIf="filteredStats.stats.hourly_breakdown.length > 0" class="chart-container">
            <h4>Distribución por Hora</h4>
            <div class="hourly-chart">
              <div *ngFor="let hour of filteredStats.stats.hourly_breakdown" class="hourly-bar">
                <div class="bar-container">
                  <div class="bar" [style.height.%]="getBarHeight(hour.count, getMaxHourlyCount())">
                  </div>
                </div>
                <div class="bar-label">{{hour._id}}:00</div>
                <div class="bar-value">{{hour.count}}</div>
              </div>
            </div>
          </div>

          <div *ngIf="filteredStats.stats.user_breakdown.length > 0" class="chart-container">
            <h4>Por Usuario</h4>
            <div class="user-breakdown-list">
              <div *ngFor="let user of filteredStats.stats.user_breakdown" class="user-breakdown-item">
                <div class="user-info">
                  <strong>{{user._id}}</strong>
                </div>
                <div class="user-metrics">
                  <span class="metric">{{formatNumber(user.count)}} facturas</span>
                  <span class="metric">{{formatCurrency(user.total_amount)}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'users'" class="tab-content">

      <div class="users-section">
        <div class="section-header">
          <h3>Gestión de Usuarios</h3>
          <div class="section-actions">
            <span class="total-count">Total: {{formatNumber(totalUsers)}} usuarios</span>
          </div>
        </div>

        <div *ngIf="loadingUsers" class="loading-users">
          <div class="spinner-small"></div>
          <span>Cargando usuarios...</span>
        </div>

        <div *ngIf="!loadingUsers" class="users-table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Roles</th>
                <th>Estado</th>
                <th>Creado</th>
                <th>Último Login</th>
                <th>Límite/Trial</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of users; trackBy: trackByEmail">
                <td class="user-info">
                  <div class="user-details">
                    <strong>{{user.name || 'Sin nombre'}}</strong>
                    <small>{{user.email}}</small>
                  </div>
                </td>
                <td>
                  <span [class]="getRoleClass(user.role)">
                    {{user.role === 'admin' ? 'Admin' : 'Usuario'}}
                  </span>
                </td>
                <td>
                  <span [class]="getStatusClass(user.status)">
                    {{user.status === 'active' ? 'Activo' : 'Suspendido'}}
                  </span>
                </td>
                <td>{{formatDate(user.created_at)}}</td>
                <td>{{formatDate(user.last_login)}}</td>
                <td>
                  <div class="trial-info">
                    <span *ngIf="user.is_trial_user" class="trial-badge">Trial</span>
                    <span *ngIf="!user.is_trial_user" class="premium-badge">Premium</span>
                    <small *ngIf="user.ai_invoices_processed !== undefined">
                      {{user.ai_invoices_processed}}/{{user.ai_invoices_limit === -1 ? '∞' : user.ai_invoices_limit}}
                    </small>
                  </div>
                </td>
                <td class="actions">
                  <div class="action-buttons">
                    <button *ngIf="!isProtectedAdmin(user)" class="btn-action"
                      [class.btn-promote]="user.role === 'user'" [class.btn-demote]="user.role === 'admin'"
                      (click)="updateUserRole(user, user.role === 'admin' ? 'user' : 'admin')"
                      [title]="user.role === 'admin' ? 'Quitar admin' : 'Hacer admin'">
                      <i [class]="user.role === 'admin' ? 'bi bi-person-dash' : 'bi bi-person-plus'"></i>
                    </button>

                    <button *ngIf="!isProtectedAdmin(user)" class="btn-action"
                      [class.btn-suspend]="user.status === 'active'" [class.btn-activate]="user.status === 'suspended'"
                      (click)="updateUserStatus(user, user.status === 'active' ? 'suspended' : 'active')"
                      [title]="user.status === 'active' ? 'Suspender' : 'Activar'">
                      <i [class]="user.status === 'active' ? 'bi bi-person-slash' : 'bi bi-person-check'"></i>
                    </button>

                    <span *ngIf="isProtectedAdmin(user)" class="protected-admin">
                      <i class="bi bi-shield-check" title="Administrador protegido"></i>
                    </span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div *ngIf="totalPages > 1" class="pagination">
          <button class="btn-page" [disabled]="currentPage <= 1" (click)="prevPage()">
            <i class="bi bi-chevron-left"></i>
            Anterior
          </button>

          <span class="page-info">
            Página {{currentPage}} de {{totalPages}}
          </span>

          <button class="btn-page" [disabled]="currentPage >= totalPages" (click)="nextPage()">
            Siguiente
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'plans'" class="tab-content">
      <app-plans-management></app-plans-management>
    </div>

    <div *ngIf="activeTab === 'subscriptions'" class="tab-content">
      <div class="users-section"> <!-- Reusing users-section class for consistent styling -->
        <div class="section-header">
          <h3>Gestión de Suscripciones</h3>
          <div class="section-actions">
            <span class="total-count">Total: {{formatNumber(totalSubscriptions)}}</span>
          </div>
        </div>

        <div *ngIf="loadingSubscriptions" class="loading-users">
          <div class="spinner-small"></div>
          <span>Cargando suscripciones...</span>
        </div>

        <div *ngIf="!loadingSubscriptions" class="users-table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Plan</th>
                <th>Estado</th>
                <th>Inicio</th>
                <th>Próx. Cobro</th>
                <th>Tarjeta</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let sub of subscriptions; trackBy: trackBySub">
                <td>
                  <div class="user-details">
                    <strong>{{sub.user_email}}</strong>
                  </div>
                </td>
                <td>{{sub.plan_name}}</td>
                <td>
                  <span [class]="getStatusClass(sub.status)">{{sub.status}}</span>
                </td>
                <td>{{formatDate(sub.started_at)}}</td>
                <td>
                  <span [style.color]="sub.next_billing_date < dateNow ? 'red' : 'inherit'">
                    {{formatDate(sub.next_billing_date)}}
                  </span>
                </td>
                <td>
                  <span *ngIf="sub.has_card" class="badge-success"><i class="bi bi-credit-card"></i> Vinculada</span>
                  <span *ngIf="!sub.has_card" class="badge-warning">Sin Tarjeta</span>
                </td>
                <td class="actions">
                  <button class="btn-action btn-promote" (click)="retryCharge(sub)" title="Reintentar Cobro">
                    <i class="bi bi-currency-dollar"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- AI Limits Tab -->
    <div *ngIf="activeTab === 'ai-limits'" class="tab-content">
      <div class="section-header">
        <h3>Gestión de Límites de IA</h3>
        <button class="btn btn-primary" (click)="loadAiLimitsData()">
          <i class="bi bi-arrow-clockwise"></i>
          Actualizar
        </button>
      </div>

      <!-- Scheduler Status -->
      <div class="ai-limits-section">
        <h4>Estado del Reseteo Automático</h4>

        <div *ngIf="loadingSchedulerStatus" class="loading">
          <div class="spinner-small"></div>
          <span>Cargando estado del scheduler...</span>
        </div>

        <div *ngIf="!loadingSchedulerStatus && schedulerStatus" class="scheduler-info">
          <div class="info-grid">
            <div class="info-card">
              <div class="info-icon scheduler">
                <i class="bi bi-calendar-event"></i>
              </div>
              <div class="info-content">
                <h5>Próximo Reseteo</h5>
                <p>{{formatDate(schedulerStatus.next_reset_date)}}</p>
              </div>
            </div>

            <div class="info-card">
              <div class="info-icon" [class.success]="schedulerStatus.scheduler.running"
                [class.danger]="!schedulerStatus.scheduler.running">
                <i class="bi" [class.bi-play-circle]="schedulerStatus.scheduler.running"
                  [class.bi-pause-circle]="!schedulerStatus.scheduler.running"></i>
              </div>
              <div class="info-content">
                <h5>Scheduler</h5>
                <p>{{schedulerStatus.scheduler.running ? 'Activo' : 'Inactivo'}}</p>
              </div>
            </div>

            <div class="info-card">
              <div class="info-icon warning" *ngIf="schedulerStatus.should_run_today">
                <i class="bi bi-exclamation-triangle"></i>
              </div>
              <div class="info-icon info" *ngIf="!schedulerStatus.should_run_today">
                <i class="bi bi-info-circle"></i>
              </div>
              <div class="info-content">
                <h5>Estado Hoy</h5>
                <p>{{schedulerStatus.should_run_today ? 'Reseteo pendiente' : 'Sin reseteo hoy'}}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Reset Statistics -->
      <div class="ai-limits-section">
        <h4>Estadísticas de Reseteo</h4>

        <div *ngIf="loadingResetStats" class="loading">
          <div class="spinner-small"></div>
          <span>Cargando estadísticas...</span>
        </div>

        <div *ngIf="!loadingResetStats && resetStats" class="reset-stats">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon users">
                <i class="bi bi-people"></i>
              </div>
              <div class="stat-content">
                <h3>{{formatNumber(resetStats.active_subscriptions)}}</h3>
                <p>Suscripciones Activas</p>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon success">
                <i class="bi bi-arrow-clockwise"></i>
              </div>
              <div class="stat-content">
                <h3>{{formatNumber(resetStats.resetted_this_month)}}</h3>
                <p>Reseteados Este Mes</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Manual Actions -->
      <div class="ai-limits-section">
        <h4>Acciones Manuales</h4>

        <div class="manual-actions">
          <div class="action-group">
            <h5>Reseteo Mensual Manual</h5>
            <p>Ejecuta el reseteo mensual de límites para todos los usuarios con planes activos</p>
            <button class="btn btn-warning" (click)="executeMonthlyReset()" [disabled]="loadingMonthlyReset">
              <i class="bi bi-arrow-repeat"></i>
              <span *ngIf="!loadingMonthlyReset">Ejecutar Reseteo Mensual</span>
              <span *ngIf="loadingMonthlyReset">Ejecutando...</span>
            </button>
          </div>

          <div class="action-group">
            <h5>Reset Individual</h5>
            <p>Resetea los límites de IA de un usuario específico</p>

            <div class="user-reset-form">
              <div class="form-group">
                <label>Usuario:</label>
                <select [(ngModel)]="selectedUserForReset" class="form-control">
                  <option value="">Seleccionar usuario...</option>
                  <option *ngFor="let user of users; trackBy: trackByEmail" [value]="user.email">
                    {{user.name || user.email}} ({{user.email}})
                  </option>
                </select>
              </div>

              <button class="btn btn-info" (click)="resetUserLimits()"
                [disabled]="!selectedUserForReset || loadingUserReset">
                <i class="bi bi-person-refresh"></i>
                <span *ngIf="!loadingUserReset">Resetear Usuario</span>
                <span *ngIf="loadingUserReset">Reseteando...</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>