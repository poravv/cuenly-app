<div class="admin-panel">
  <!-- Header compacto -->
  <div class="admin-header">
    <div class="admin-header-content">
      <h1 class="admin-title">
        <i class="bi bi-shield-check"></i> Administración
      </h1>
      <button class="btn-refresh" (click)="loadData()" [disabled]="loading" title="Recargar datos">
        <i class="bi bi-arrow-clockwise" [class.spin]="loading"></i>
      </button>
    </div>
  </div>

  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando datos del sistema...</p>
  </div>

  <div *ngIf="!loading" class="admin-content">

    <!-- Navegación reorganizada: 4 tabs claros -->
    <div class="tab-navigation">
      <button class="tab-button" [class.active]="activeTab === 'stats'" (click)="setActiveTab('stats')">
        <i class="bi bi-speedometer2"></i>
        <span class="tab-label">Resumen</span>
      </button>
      <button class="tab-button" [class.active]="activeTab === 'users'" (click)="setActiveTab('users')">
        <i class="bi bi-people"></i>
        <span class="tab-label">Usuarios</span>
        <span class="tab-badge" *ngIf="userStats.total_users">{{userStats.total_users}}</span>
      </button>
      <button class="tab-button" [class.active]="activeTab === 'billing'" (click)="setActiveTab('billing')">
        <i class="bi bi-credit-card"></i>
        <span class="tab-label">Facturación</span>
      </button>
      <button class="tab-button" [class.active]="activeTab === 'system'" (click)="setActiveTab('system')">
        <i class="bi bi-gear"></i>
        <span class="tab-label">Sistema</span>
        <span class="tab-badge tab-badge--alert" *ngIf="getTotalFailed() > 0">!</span>
      </button>
    </div>

    <!-- ============================================ -->
    <!-- TAB: RESUMEN (KPIs + Colas + Gráficos)       -->
    <!-- ============================================ -->
    <div *ngIf="activeTab === 'stats'" class="tab-content">

      <!-- KPIs principales -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon users">
            <i class="bi bi-people"></i>
          </div>
          <div class="stat-content">
            <h3>{{formatNumber(userStats.total_users)}}</h3>
            <p>Usuarios</p>
            <small>{{formatNumber(userStats.active_users)}} activos · {{formatNumber(userStats.trial_users)}} trial</small>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon invoices">
            <i class="bi bi-receipt"></i>
          </div>
          <div class="stat-content">
            <h3>{{formatNumber(invoiceStats.total_invoices)}}</h3>
            <p>Facturas</p>
            <small>{{formatNumber(invoiceStats.total_items)}} ítems procesados</small>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon xml-source">
            <i class="bi bi-file-earmark-code"></i>
          </div>
          <div class="stat-content">
            <h3>{{getSourcePercent(invoiceStats.source_totals?.xml_nativo || 0)}}%</h3>
            <p>XML Nativo</p>
            <small>{{formatNumber(invoiceStats.source_totals?.xml_nativo || 0)}} facturas</small>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon ai-source">
            <i class="bi bi-robot"></i>
          </div>
          <div class="stat-content">
            <h3>{{getSourcePercent(invoiceStats.source_totals?.openai_vision || 0)}}%</h3>
            <p>OpenAI Vision</p>
            <small>{{formatNumber(invoiceStats.source_totals?.openai_vision || 0)}} facturas</small>
          </div>
        </div>
      </div>

      <!-- Cola RQ -->
      <div class="rq-stats-row" *ngIf="queueStats || loadingQueueStats">
        <h4 class="rq-title"><i class="bi bi-hdd-stack"></i> Colas de Procesamiento</h4>
        <div class="rq-cards">
          <div class="rq-card" *ngIf="loadingQueueStats">
            <span class="spinner-border spinner-border-sm text-muted"></span>
            <span class="ms-2 text-muted small">Cargando...</span>
          </div>
          <ng-container *ngIf="!loadingQueueStats && queueStats">
            <div class="rq-card">
              <i class="bi bi-cpu text-primary"></i>
              <div>
                <strong>{{queueStats.workers_online}}</strong>
                <span class="rq-label">Workers</span>
              </div>
            </div>
            <div class="rq-card">
              <i class="bi bi-hourglass-split text-warning"></i>
              <div>
                <strong>{{formatNumber(getTotalQueued())}}</strong>
                <span class="rq-label">En cola</span>
              </div>
            </div>
            <div class="rq-card" [class.rq-card--alert]="getTotalFailed() > 0">
              <i class="bi bi-exclamation-circle" [class.text-danger]="getTotalFailed() > 0" [class.text-muted]="getTotalFailed() === 0"></i>
              <div>
                <strong [class.text-danger]="getTotalFailed() > 0">{{formatNumber(getTotalFailed())}}</strong>
                <span class="rq-label">Fallidos</span>
              </div>
            </div>
            <div class="rq-card rq-detail">
              <div class="rq-queue-line">
                <span class="rq-q-name">High:</span>
                <span class="rq-q-val">{{queueStats.queues.high?.queued || 0}}</span>
              </div>
              <div class="rq-queue-line">
                <span class="rq-q-name">Default:</span>
                <span class="rq-q-val">{{queueStats.queues.default?.queued || 0}}</span>
              </div>
              <div class="rq-queue-line">
                <span class="rq-q-name">Low:</span>
                <span class="rq-q-val">{{queueStats.queues.low?.queued || 0}}</span>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Gráficos lado a lado -->
      <div class="charts-section">
        <div class="chart-container">
          <h3>Facturas por Mes</h3>
          <div class="chart-content">
            <div *ngIf="getRecentMonths().length === 0" class="no-data">Sin datos</div>
            <div *ngIf="getRecentMonths().length > 0" class="simple-chart">
              <div *ngFor="let month of getRecentMonths()" class="chart-bar"
                [title]="month.month + ': ' + month.count + ' (XML: ' + month.xml_nativo + ' | IA: ' + month.openai_vision + ')'">
                <div class="bar-label">{{month.month}}</div>
                <div class="bar-container">
                  <div class="bar" [style.height.%]="(month.count / getMaxMonthCount()) * 100"></div>
                </div>
                <div class="bar-value">{{month.count}}</div>
                <div class="bar-source-mini">
                  <span class="src-xml" [title]="'XML: ' + month.xml_nativo">{{month.xml_nativo}}</span>
                  <span class="src-ai" [title]="'IA: ' + month.openai_vision">{{month.openai_vision}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="chart-container">
          <h3>Top 5 Usuarios</h3>
          <div class="chart-content">
            <div *ngIf="getTopUsers().length === 0" class="no-data">Sin datos</div>
            <div *ngIf="getTopUsers().length > 0" class="user-stats-list">
              <div *ngFor="let user of getTopUsers()" class="user-stat-item">
                <div class="user-email">{{user.email}}</div>
                <div class="user-stats">
                  <span class="stat-value">{{formatNumber(user.count)}} facturas</span>
                  <span class="stat-total">{{formatCurrency(user.total)}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Estadísticas filtradas (colapsable) -->
      <div class="advanced-stats-section">
        <div class="section-toggle" (click)="showAdvancedStats = !showAdvancedStats">
          <h3><i class="bi bi-funnel"></i> Estadísticas Filtradas</h3>
          <i class="bi" [ngClass]="showAdvancedStats ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
        </div>

        <div *ngIf="showAdvancedStats" class="advanced-stats-body">
          <div class="filters-form">
            <div class="filter-row">
              <div class="filter-group">
                <label>Desde</label>
                <input type="date" [(ngModel)]="statsFilters.start_date" class="form-control">
              </div>
              <div class="filter-group">
                <label>Hasta</label>
                <input type="date" [(ngModel)]="statsFilters.end_date" class="form-control">
              </div>
              <div class="filter-group">
                <label>Usuario</label>
                <select [(ngModel)]="statsFilters.user_email" class="form-control">
                  <option value="">Todos</option>
                  <option *ngFor="let user of users; trackBy: trackByEmail" [value]="user.email">
                    {{user.name || user.email}}
                  </option>
                </select>
              </div>
              <div class="filter-group filter-group--action">
                <button class="btn btn-primary" (click)="loadFilteredStats()" [disabled]="loadingFilteredStats">
                  <i class="bi bi-search"></i> Filtrar
                </button>
              </div>
            </div>
          </div>

          <div *ngIf="loadingFilteredStats" class="loading-stats">
            <div class="spinner-small"></div>
            <span>Cargando...</span>
          </div>

          <div *ngIf="filteredStats && !loadingFilteredStats" class="filtered-stats-content">
            <div class="filtered-summary">
              <div class="summary-card">
                <h4>{{formatNumber(filteredStats.stats.total_invoices)}}</h4>
                <p>Facturas</p>
              </div>
              <div class="summary-card">
                <h4>{{formatCurrency(filteredStats.stats.total_amount)}}</h4>
                <p>Monto Total</p>
              </div>
              <div class="summary-card">
                <h4>{{formatCurrency(filteredStats.stats.avg_amount)}}</h4>
                <p>Promedio</p>
              </div>
            </div>

            <div *ngIf="filteredStats.stats.daily_breakdown?.length > 0" class="chart-container">
              <h4>Distribución Diaria</h4>
              <div class="daily-chart">
                <div *ngFor="let day of filteredStats.stats.daily_breakdown" class="daily-bar">
                  <div class="bar-container">
                    <div class="bar" [style.height.%]="getBarHeight(day.count, getMaxDailyCount())"></div>
                  </div>
                  <div class="bar-label">{{formatShortDate(day._id)}}</div>
                  <div class="bar-value">{{day.count}}</div>
                </div>
              </div>
            </div>

            <div *ngIf="filteredStats.stats.hourly_breakdown?.length > 0" class="chart-container">
              <h4>Distribución por Hora</h4>
              <div class="hourly-chart">
                <div *ngFor="let hour of filteredStats.stats.hourly_breakdown" class="hourly-bar">
                  <div class="bar-container">
                    <div class="bar" [style.height.%]="getBarHeight(hour.count, getMaxHourlyCount())"></div>
                  </div>
                  <div class="bar-label">{{hour._id}}h</div>
                  <div class="bar-value">{{hour.count}}</div>
                </div>
              </div>
            </div>

            <div *ngIf="filteredStats.stats.user_breakdown?.length > 0" class="chart-container">
              <h4>Por Usuario</h4>
              <div class="user-breakdown-list">
                <div *ngFor="let user of filteredStats.stats.user_breakdown" class="user-breakdown-item">
                  <strong>{{user._id}}</strong>
                  <div class="user-metrics">
                    <span class="metric">{{formatNumber(user.count)}} facturas</span>
                    <span class="metric">{{formatCurrency(user.total_amount)}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- TAB: USUARIOS                                -->
    <!-- ============================================ -->
    <div *ngIf="activeTab === 'users'" class="tab-content">
      <div class="users-section">
        <div class="section-header">
          <h3>Usuarios</h3>
          <div class="section-actions">
            <div class="search-input-wrapper">
              <i class="bi bi-search search-icon"></i>
              <input type="text" class="form-control form-control-sm search-input"
                placeholder="Buscar por email o nombre..."
                [(ngModel)]="userSearchTerm" (ngModelChange)="onUserSearch()">
            </div>
            <span class="total-count">{{formatNumber(totalUsers)}}</span>
          </div>
        </div>

        <div *ngIf="loadingUsers" class="loading-users">
          <div class="spinner-small"></div>
          <span>Cargando usuarios...</span>
        </div>

        <div *ngIf="!loadingUsers" class="users-table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Rol</th>
                <th>Estado</th>
                <th class="hide-mobile">Creado</th>
                <th class="hide-mobile">Último Login</th>
                <th>Plan/IA</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of users; trackBy: trackByEmail">
                <td class="user-info">
                  <div class="user-details">
                    <strong>{{user.name || 'Sin nombre'}}</strong>
                    <small>{{user.email}}</small>
                  </div>
                </td>
                <td>
                  <span [class]="getRoleClass(user.role)">
                    {{user.role === 'admin' ? 'Admin' : 'Usuario'}}
                  </span>
                </td>
                <td>
                  <span [class]="getStatusClass(user.status)">
                    {{user.status === 'active' ? 'Activo' : 'Suspendido'}}
                  </span>
                </td>
                <td class="hide-mobile">{{formatDate(user.created_at)}}</td>
                <td class="hide-mobile">{{formatDate(user.last_login)}}</td>
                <td>
                  <div class="trial-info">
                    <span *ngIf="user.is_trial_user" class="trial-badge">Trial</span>
                    <span *ngIf="!user.is_trial_user" class="premium-badge">Pagado</span>
                    <small *ngIf="user.ai_invoices_processed !== undefined">
                      {{user.ai_invoices_processed}}/{{user.ai_invoices_limit === -1 ? '∞' : user.ai_invoices_limit}}
                    </small>
                  </div>
                </td>
                <td class="actions">
                  <div class="action-buttons">
                    <button *ngIf="!isProtectedAdmin(user)" class="btn-action"
                      [class.btn-promote]="user.role === 'user'" [class.btn-demote]="user.role === 'admin'"
                      (click)="updateUserRole(user, user.role === 'admin' ? 'user' : 'admin')"
                      [title]="user.role === 'admin' ? 'Quitar admin' : 'Hacer admin'">
                      <i [class]="user.role === 'admin' ? 'bi bi-person-dash' : 'bi bi-person-plus'"></i>
                    </button>

                    <button *ngIf="!isProtectedAdmin(user)" class="btn-action"
                      [class.btn-suspend]="user.status === 'active'" [class.btn-activate]="user.status === 'suspended'"
                      (click)="updateUserStatus(user, user.status === 'active' ? 'suspended' : 'active')"
                      [title]="user.status === 'active' ? 'Suspender' : 'Activar'">
                      <i [class]="user.status === 'active' ? 'bi bi-person-slash' : 'bi bi-person-check'"></i>
                    </button>

                    <span *ngIf="isProtectedAdmin(user)" class="protected-admin">
                      <i class="bi bi-shield-check" title="Tu cuenta"></i>
                    </span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div *ngIf="totalPages > 1" class="pagination">
          <button class="btn-page" [disabled]="currentPage <= 1" (click)="prevPage()">
            <i class="bi bi-chevron-left"></i> Anterior
          </button>
          <span class="page-info">{{currentPage}} / {{totalPages}}</span>
          <button class="btn-page" [disabled]="currentPage >= totalPages" (click)="nextPage()">
            Siguiente <i class="bi bi-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- TAB: FACTURACIÓN (Planes + Suscripciones)    -->
    <!-- ============================================ -->
    <div *ngIf="activeTab === 'billing'" class="tab-content">

      <!-- Sub-tabs para Planes y Suscripciones -->
      <div class="sub-tab-nav">
        <button class="sub-tab" [class.active]="billingSubTab === 'plans'" (click)="billingSubTab = 'plans'">
          <i class="bi bi-boxes"></i> Planes
        </button>
        <button class="sub-tab" [class.active]="billingSubTab === 'subscriptions'" (click)="setBillingSubTab('subscriptions')">
          <i class="bi bi-arrow-repeat"></i> Suscripciones
          <span class="sub-tab-count" *ngIf="totalSubscriptions">{{totalSubscriptions}}</span>
        </button>
      </div>

      <!-- Planes -->
      <div *ngIf="billingSubTab === 'plans'">
        <app-plans-management></app-plans-management>
      </div>

      <!-- Suscripciones -->
      <div *ngIf="billingSubTab === 'subscriptions'">
        <div class="users-section">
          <div class="section-header">
            <h3>Suscripciones</h3>
            <div class="section-actions">
              <select class="form-control form-control-sm"
                [(ngModel)]="subscriptionsStatusFilter" (ngModelChange)="onSubscriptionsFilterChange()">
                <option value="all">Todos</option>
                <option value="active">Activas</option>
                <option value="past_due">Vencidas</option>
                <option value="cancelled">Canceladas</option>
              </select>
              <span class="total-count">{{formatNumber(totalSubscriptions)}}</span>
            </div>
          </div>

          <div *ngIf="loadingSubscriptions" class="loading-users">
            <div class="spinner-small"></div>
            <span>Cargando...</span>
          </div>

          <div *ngIf="!loadingSubscriptions" class="users-table-container">
            <table class="users-table">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Plan</th>
                  <th>Estado</th>
                  <th class="hide-mobile">Inicio</th>
                  <th>Próx. Cobro</th>
                  <th class="hide-mobile">Tarjeta</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let sub of subscriptions; trackBy: trackBySub">
                  <td>
                    <div class="user-details">
                      <strong>{{sub.user_email}}</strong>
                    </div>
                  </td>
                  <td>{{sub.plan_name}}</td>
                  <td>
                    <span [class]="getSubscriptionStatusClass(sub.status)">{{sub.status}}</span>
                  </td>
                  <td class="hide-mobile">{{formatDate(sub.started_at)}}</td>
                  <td>
                    <span [class.text-danger]="sub.next_billing_date < dateNow">
                      {{formatDate(sub.next_billing_date)}}
                    </span>
                  </td>
                  <td class="hide-mobile">
                    <span *ngIf="sub.has_card" class="badge-success"><i class="bi bi-credit-card"></i> OK</span>
                    <span *ngIf="!sub.has_card" class="badge-warning">Sin Tarjeta</span>
                  </td>
                  <td class="actions">
                    <button class="btn-action btn-promote" (click)="retryCharge(sub)" title="Reintentar Cobro"
                      [disabled]="sub.status === 'cancelled'">
                      <i class="bi bi-currency-dollar"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div *ngIf="subscriptionsTotalPages > 1" class="pagination">
            <button class="btn-page" [disabled]="subscriptionsPage <= 1" (click)="onSubscriptionsPageChange(subscriptionsPage - 1)">
              <i class="bi bi-chevron-left"></i> Anterior
            </button>
            <span class="page-info">{{subscriptionsPage}} / {{subscriptionsTotalPages}}</span>
            <button class="btn-page" [disabled]="subscriptionsPage >= subscriptionsTotalPages" (click)="onSubscriptionsPageChange(subscriptionsPage + 1)">
              Siguiente <i class="bi bi-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- TAB: SISTEMA (IA + Auditoría)                -->
    <!-- ============================================ -->
    <div *ngIf="activeTab === 'system'" class="tab-content">

      <!-- Sub-tabs -->
      <div class="sub-tab-nav">
        <button class="sub-tab" [class.active]="systemSubTab === 'ai-limits'" (click)="systemSubTab = 'ai-limits'">
          <i class="bi bi-robot"></i> Límites IA
        </button>
        <button class="sub-tab" [class.active]="systemSubTab === 'audit'" (click)="setSystemSubTab('audit')">
          <i class="bi bi-journal-text"></i> Auditoría
          <span class="sub-tab-count" *ngIf="auditTotal">{{auditTotal}}</span>
        </button>
      </div>

      <!-- Límites IA -->
      <div *ngIf="systemSubTab === 'ai-limits'">
        <div class="section-header">
          <h3>Límites de IA</h3>
          <button class="btn btn-primary btn-sm" (click)="loadAiLimitsData()">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
          </button>
        </div>

        <!-- Scheduler + Reset Stats en grid compacto -->
        <div class="ai-info-grid">
          <div class="ai-info-card">
            <div class="ai-info-header">
              <i class="bi bi-calendar-event text-primary"></i>
              <span>Próximo Reseteo</span>
            </div>
            <div class="ai-info-value" *ngIf="!loadingSchedulerStatus && schedulerStatus">
              {{formatDate(schedulerStatus.next_reset_date)}}
            </div>
            <div class="ai-info-value text-muted" *ngIf="loadingSchedulerStatus">Cargando...</div>
          </div>

          <div class="ai-info-card">
            <div class="ai-info-header">
              <i class="bi" [ngClass]="schedulerStatus?.scheduler?.running ? 'bi-play-circle text-success' : 'bi-pause-circle text-danger'"></i>
              <span>Scheduler</span>
            </div>
            <div class="ai-info-value" *ngIf="!loadingSchedulerStatus && schedulerStatus">
              {{schedulerStatus.scheduler.running ? 'Activo' : 'Inactivo'}}
            </div>
            <div class="ai-info-value text-muted" *ngIf="loadingSchedulerStatus">Cargando...</div>
          </div>

          <div class="ai-info-card">
            <div class="ai-info-header">
              <i class="bi bi-people text-info"></i>
              <span>Suscripciones Activas</span>
            </div>
            <div class="ai-info-value" *ngIf="!loadingResetStats && resetStats">
              {{formatNumber(resetStats.active_subscriptions)}}
            </div>
            <div class="ai-info-value text-muted" *ngIf="loadingResetStats">Cargando...</div>
          </div>

          <div class="ai-info-card">
            <div class="ai-info-header">
              <i class="bi bi-arrow-clockwise text-success"></i>
              <span>Reseteados Este Mes</span>
            </div>
            <div class="ai-info-value" *ngIf="!loadingResetStats && resetStats">
              {{formatNumber(resetStats.resetted_this_month)}}
            </div>
            <div class="ai-info-value text-muted" *ngIf="loadingResetStats">Cargando...</div>
          </div>
        </div>

        <!-- Acciones manuales -->
        <div class="manual-actions">
          <div class="action-group">
            <div class="action-group-header">
              <div>
                <h5>Reseteo Mensual</h5>
                <p>Resetea límites de IA de todos los usuarios con planes activos</p>
              </div>
              <button class="btn btn-warning btn-sm" (click)="executeMonthlyReset()" [disabled]="loadingMonthlyReset">
                <i class="bi bi-arrow-repeat"></i>
                {{loadingMonthlyReset ? 'Ejecutando...' : 'Ejecutar'}}
              </button>
            </div>
          </div>

          <div class="action-group">
            <div class="action-group-header">
              <div>
                <h5>Reset Individual</h5>
                <p>Resetea los límites de un usuario específico</p>
              </div>
            </div>
            <div class="user-reset-form">
              <select [(ngModel)]="selectedUserForReset" class="form-control form-control-sm">
                <option value="">Seleccionar usuario...</option>
                <option *ngFor="let user of users; trackBy: trackByEmail" [value]="user.email">
                  {{user.name || user.email}} ({{user.email}})
                </option>
              </select>
              <button class="btn btn-info btn-sm" (click)="resetUserLimits()"
                [disabled]="!selectedUserForReset || loadingUserReset">
                <i class="bi bi-person-gear"></i>
                {{loadingUserReset ? 'Reseteando...' : 'Resetear'}}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Auditoría -->
      <div *ngIf="systemSubTab === 'audit'">
        <div class="users-section">
          <div class="section-header">
            <h3>Log de Auditoría</h3>
            <div class="section-actions">
              <select class="form-control form-control-sm"
                [(ngModel)]="auditActionFilter" (ngModelChange)="onAuditFilterChange()">
                <option value="">Todas</option>
                <option value="user_role_changed">Cambio de rol</option>
                <option value="user_suspended">Suspensión</option>
                <option value="user_activated">Activación</option>
                <option value="monthly_ai_reset">Reset mensual IA</option>
                <option value="user_ai_reset">Reset IA individual</option>
              </select>
              <span class="total-count">{{formatNumber(auditTotal)}}</span>
            </div>
          </div>

          <div *ngIf="loadingAudit" class="loading-users">
            <div class="spinner-small"></div>
            <span>Cargando...</span>
          </div>

          <div *ngIf="!loadingAudit && auditLogs.length === 0" class="no-data">
            <i class="bi bi-journal-text" style="font-size: 2rem; color: #9ca3af;"></i>
            <p>No hay registros de auditoría</p>
          </div>

          <div *ngIf="!loadingAudit && auditLogs.length > 0" class="users-table-container">
            <table class="users-table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Acción</th>
                  <th>Admin</th>
                  <th>Usuario</th>
                  <th class="hide-mobile">Detalles</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let log of auditLogs; trackBy: trackByAuditId">
                  <td><small>{{formatDate(log.timestamp)}}</small></td>
                  <td>
                    <span [class]="getActionClass(log.action)">{{getActionLabel(log.action)}}</span>
                  </td>
                  <td><small>{{log.admin_email}}</small></td>
                  <td><small>{{log.target_user || '—'}}</small></td>
                  <td class="hide-mobile">
                    <small *ngIf="log.details && (log.details | json) !== '{}'" class="text-muted">
                      {{log.details | json}}
                    </small>
                    <span *ngIf="!log.details || (log.details | json) === '{}'" class="text-muted">—</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div *ngIf="auditTotalPages > 1" class="pagination">
            <button class="btn-page" [disabled]="auditPage <= 1" (click)="onAuditPageChange(auditPage - 1)">
              <i class="bi bi-chevron-left"></i> Anterior
            </button>
            <span class="page-info">{{auditPage}} / {{auditTotalPages}}</span>
            <button class="btn-page" [disabled]="auditPage >= auditTotalPages" (click)="onAuditPageChange(auditPage + 1)">
              Siguiente <i class="bi bi-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>