<div class="container-fluid mt-4 px-4 px-lg-5">
  <div class="row mb-3">
    <div class="col-12 d-flex align-items-center justify-content-between flex-wrap">
      <div>
        <nav aria-label="breadcrumb" class="mb-2">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a routerLink="/" class="text-decoration-none">Inicio</a></li>
            <li class="breadcrumb-item active">Lista de Facturas</li>
          </ol>
        </nav>
        <h1 class="h3 fw-bold mb-0 d-flex align-items-center">
          <i class="bi bi-journals text-primary me-2"></i>
          Cabeceras de Facturas
        </h1>
      </div>
      <div class="d-flex gap-2 mt-2 mt-md-0">
        <button class="btn btn-danger" (click)="deleteSelected()" [disabled]="!hasSelection || deleteLoading"
          *ngIf="hasSelection">
          <i class="bi bi-trash me-1"></i>
          Eliminar ({{ selectedHeaders.size }})
        </button>
        <button class="btn btn-outline-primary" (click)="refresh()" [disabled]="loading">
          <i class="bi bi-arrow-repeat"></i> Actualizar
        </button>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-3">
          <label class="form-label small fw-semibold">Mes</label>
          <input type="month" class="form-control" [(ngModel)]="month" (change)="refresh()">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label small fw-semibold">Buscar</label>
          <input type="text" class="form-control" placeholder="Texto (emisor/receptor/nro)" [(ngModel)]="search"
            (keyup.enter)="refresh()">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label small fw-semibold">Nombre Emisor</label>
          <input type="text" class="form-control" placeholder="Ej: FARMACIA..." [(ngModel)]="emisorNombre"
            (keyup.enter)="refresh()">
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label small fw-semibold">RUC Emisor</label>
          <input type="text" class="form-control" [(ngModel)]="rucEmisor" (keyup.enter)="refresh()">
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label small fw-semibold">RUC Receptor</label>
          <input type="text" class="form-control" [(ngModel)]="rucReceptor" (keyup.enter)="refresh()">
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label small fw-semibold">Ordenar por</label>
          <select class="form-select" [(ngModel)]="sortBy" (change)="refresh()">
            <option value="fecha_emision">Fecha Emisión</option>
            <option value="created_at">Recientemente Procesados</option>
          </select>
        </div>
        <div class="col-12 col-md-2 d-grid">
          <button class="btn btn-primary" (click)="refresh()" [disabled]="loading">
            <i class="bi bi-filter-circle me-1"></i> Filtrar
          </button>
        </div>
      </div>
      <!-- Chips de filtros activos -->
      <div class="mt-3 d-flex flex-wrap gap-2" *ngIf="chips.length">
        <span class="chip" *ngFor="let c of chips">
          <span class="chip-label">{{ c.label }}:</span>
          <span class="chip-value">{{ c.value }}</span>
          <button class="chip-close" (click)="removeChip(c.key)" aria-label="Quitar filtro">
            <i class="bi bi-x"></i>
          </button>
        </span>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <div *ngIf="loading" class="py-3">
        <div class="skeleton-row" *ngFor="let s of [1,2,3,4,5]">
          <div class="skeleton sk-icon"></div>
          <div class="skeleton sk-col"></div>
          <div class="skeleton sk-col"></div>
          <div class="skeleton sk-col"></div>
          <div class="skeleton sk-col"></div>
          <div class="skeleton sk-amt"></div>
        </div>
      </div>

      <div *ngIf="!loading && error" class="alert alert-danger border-0">{{ error }}</div>

      <div *ngIf="!loading && !error">
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th style="width: 40px;">
                  <input type="checkbox" class="form-check-input" [checked]="selectAll" (change)="toggleSelectAll()"
                    [disabled]="loading">
                </th>
                <th style="width: 40px;"></th>
                <th>Fecha</th>
                <th>Número</th>
                <th>Emisor</th>
                <th>Receptor</th>
                <th class="text-end">Total</th>
                <th class="text-center" style="width: 50px;"></th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let h of headers; trackBy: trackByHeaderId">
                <tr [class.table-active]="isSelected(h.id)">
                  <td>
                    <input type="checkbox" class="form-check-input" [checked]="isSelected(h.id)"
                      (change)="toggleSelection(h.id)">
                  </td>
                  <td>
                    <button
                      class="btn btn-sm btn-outline-primary d-inline-flex align-items-center justify-content-center"
                      (click)="toggle(h)" [disabled]="itemsLoading[h.id]" aria-label="Mostrar/ocultar detalle">
                      <span *ngIf="itemsLoading[h.id]" class="spinner-border spinner-border-sm" role="status"
                        aria-hidden="true"></span>
                      <i *ngIf="!itemsLoading[h.id]" class="bi"
                        [ngClass]="expanded[h.id] ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                    </button>
                  </td>
                  <td>{{ formatDate(h.fecha_emision) }}</td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <span>{{ h.numero_documento }}</span>
                      <span class="badge" [ngClass]="condBadgeClass(h.condicion_venta)">{{ h.condicion_venta ||
                        'CONTADO' }}</span>
                    </div>
                  </td>
                  <td>{{ h.emisor?.nombre }}</td>
                  <td>{{ h.receptor?.nombre }}</td>
                  <td class="text-end">{{ toCurrency(h.totales?.total || 0) }}</td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-outline-secondary" (click)="downloadInvoice(h.id, $event)"
                      title="Descargar PDF">
                      <i class="bi bi-download"></i>
                    </button>
                  </td>
                </tr>
                <tr *ngIf="expanded[h.id]">
                  <td colspan="8" class="p-0 border-0">
                    <div class="bg-light rounded-3 p-3 m-2">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="fw-semibold">Detalle: {{ h.numero_documento }}</div>
                      </div>
                      <!-- Resumen útil para el usuario -->
                      <div class="row g-3 mb-2 small text-muted">
                        <div class="col-12 col-lg-6">
                          <div class="d-flex flex-wrap gap-2 align-items-center">
                            <span class="badge bg-light text-dark border">Emisor RUC: {{ h.emisor?.ruc || '-' }}</span>
                            <span class="badge bg-light text-dark border">Receptor RUC: {{ h.receptor?.ruc || '-'
                              }}</span>
                            <span class="badge" [ngClass]="condBadgeClass(h.condicion_venta)">Condición: {{
                              h.condicion_venta || 'CONTADO' }}</span>
                            <span class="badge bg-secondary">Moneda: {{ h.moneda || 'GS' }}</span>
                          </div>
                        </div>
                        <div class="col-12 col-lg-6">
                          <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
                            <span class="badge bg-info text-dark" *ngIf="h.cdc">CDC: {{ (h.cdc || '').slice(0,8)
                              }}…</span>
                            <span class="badge bg-secondary" *ngIf="h.timbrado">Timbrado: {{ h.timbrado }}</span>
                            <span class="badge bg-light text-dark border">Ítems: {{ h.item_count || (itemsCache[h.id] &&
                              itemsCache[h.id].length || 0) }}</span>
                            <span class="badge bg-light text-dark border" *ngIf="h.fuente">Fuente: {{ h.fuente }}</span>
                          </div>
                        </div>
                      </div>
                      <!-- Totales desglosados -->
                      <div class="row g-2 mb-2 small">
                        <div class="col-6 col-md-3">
                          <div class="bg-white rounded-2 p-2 border">
                            <div class="text-muted">Exentas</div>
                            <div class="fw-semibold">{{ toCurrency(h.totales?.exentas || 0) }}</div>
                          </div>
                        </div>
                        <div class="col-6 col-md-3">
                          <div class="bg-white rounded-2 p-2 border">
                            <div class="text-muted">Grav. 5%</div>
                            <div class="fw-semibold">{{ toCurrency(h.totales?.gravado_5 || 0) }}</div>
                          </div>
                        </div>
                        <div class="col-6 col-md-3">
                          <div class="bg-white rounded-2 p-2 border">
                            <div class="text-muted">Grav. 10%</div>
                            <div class="fw-semibold">{{ toCurrency(h.totales?.gravado_10 || 0) }}</div>
                          </div>
                        </div>
                        <div class="col-6 col-md-3">
                          <div class="bg-white rounded-2 p-2 border">
                            <div class="text-muted">Total</div>
                            <div class="fw-bold text-primary">{{ toCurrency(h.totales?.total || 0) }}</div>
                          </div>
                        </div>
                      </div>
                      <div *ngIf="itemsLoading[h.id]" class="d-flex justify-content-center align-items-center py-3">
                        <div class="spinner-border text-primary me-2" role="status"
                          style="width: 1.5rem; height: 1.5rem;">
                          <span class="visually-hidden">Cargando...</span>
                        </div>
                        <span class="text-muted">Cargando detalles...</span>
                      </div>

                      <div *ngIf="!itemsLoading[h.id] && itemsError[h.id]" class="alert alert-danger mb-0 py-2">
                        {{ itemsError[h.id] }}
                      </div>

                      <div class="table-responsive" *ngIf="!itemsLoading[h.id] && !itemsError[h.id]">
                        <table class="table table-sm align-middle">
                          <thead>
                            <tr>
                              <th>#</th>
                              <th>Descripción (Producto/Servicio)</th>
                              <th class="text-end">Cant.</th>
                              <th>Unidad</th>
                              <th class="text-end">P. Unit</th>
                              <th class="text-end">Total</th>
                              <th>IVA</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngIf="!(itemsCache[h.id]?.length)">
                              <td colspan="7" class="text-center text-muted py-3">Sin ítems</td>
                            </tr>
                            <tr *ngFor="let it of itemsCache[h.id]">
                              <td>{{ it.linea }}</td>
                              <td>{{ it.descripcion }}</td>
                              <td class="text-end">{{ it.cantidad }}</td>
                              <td>{{ it.unidad }}</td>
                              <td class="text-end">{{ toCurrency(it.precio_unitario) }}</td>
                              <td class="text-end">{{ toCurrency(it.total) }}</td>
                              <td><span [ngClass]="ivaBadgeClass(it.iva)">{{ it.iva }}%</span></td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>

        <!-- Paginación simple -->
        <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
          <div class="text-muted">Total: {{ total }}</div>
          <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
              <label class="text-muted small mb-0">Por página</label>
              <select class="form-select form-select-sm w-auto" [ngModel]="pageSize"
                (ngModelChange)="setPageSize($event)">
                <option [ngValue]="10">10</option>
                <option [ngValue]="20">20</option>
                <option [ngValue]="50">50</option>
                <option [ngValue]="100">100</option>
              </select>
            </div>
            <div class="btn-group">
              <button class="btn btn-outline-secondary" (click)="prevPage()" [disabled]="page <= 1">Anterior</button>
              <ng-container *ngFor="let p of getPageNumbers()">
                <button class="btn" [ngClass]="p === page ? 'btn-primary' : 'btn-outline-secondary'"
                  (click)="goToPage(p)">{{ p }}</button>
              </ng-container>
              <button class="btn btn-outline-secondary" (click)="nextPage()"
                [disabled]="page >= pageCount()">Siguiente</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación de eliminación -->
<div class="modal fade" [class.show]="showDeleteConfirm" [style.display]="showDeleteConfirm ? 'block' : 'none'"
  tabindex="-1" *ngIf="showDeleteConfirm">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-exclamation-triangle text-warning me-2"></i>
          Confirmar Eliminación
        </h5>
        <button type="button" class="btn-close" (click)="cancelDelete()" [disabled]="deleteLoading"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="deleteInfo && !deleteLoading">
          <div class="alert alert-warning">
            <strong>¡Atención!</strong> Esta acción no se puede deshacer.
          </div>

          <!-- Eliminación individual -->
          <div *ngIf="selectedHeaders.size === 1">
            <p class="mb-3">Se eliminará la siguiente factura:</p>
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">{{ deleteInfo.header?.numero_documento }}</h6>
                <p class="card-text">
                  <strong>Emisor:</strong> {{ deleteInfo.header?.emisor }}<br>
                  <strong>Fecha:</strong> {{ formatDate(deleteInfo.header?.fecha_emision) }}<br>
                  <strong>Total:</strong> {{ toCurrency(deleteInfo.header?.monto_total) }}<br>
                  <strong>Ítems:</strong> {{ deleteInfo.items_count }}
                </p>
              </div>
            </div>
          </div>

          <!-- Eliminación en lote -->
          <div *ngIf="selectedHeaders.size > 1">
            <p class="mb-3">Se eliminarán <strong>{{ deleteInfo.summary?.total_invoices }}</strong> facturas:</p>
            <div class="alert alert-info">
              <div class="row">
                <div class="col-6">
                  <strong>Total facturas:</strong> {{ deleteInfo.summary?.total_invoices }}<br>
                  <strong>Total ítems:</strong> {{ deleteInfo.summary?.total_items }}
                </div>
                <div class="col-6">
                  <strong>Monto total:</strong> {{ toCurrency(deleteInfo.summary?.total_amount) }}
                </div>
              </div>
            </div>

            <div class="max-height-200 overflow-auto border rounded p-2" *ngIf="deleteInfo.invoices?.length">
              <div class="small" *ngFor="let inv of deleteInfo.invoices">
                <strong>{{ inv.numero_documento }}</strong> - {{ inv.emisor }} - {{ toCurrency(inv.monto_total) }}
              </div>
            </div>
          </div>

          <p class="text-danger mt-3">
            <i class="bi bi-info-circle me-1"></i>
            {{ deleteInfo.warning }}
          </p>
        </div>

        <div *ngIf="deleteLoading" class="text-center py-3">
          <div class="spinner-border text-primary me-2" role="status">
            <span class="visually-hidden">Eliminando...</span>
          </div>
          <span>Eliminando facturas...</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelDelete()" [disabled]="deleteLoading">
          Cancelar
        </button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()" [disabled]="deleteLoading">
          <i class="bi bi-trash me-1"></i>
          Eliminar Definitivamente
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showDeleteConfirm" *ngIf="showDeleteConfirm"></div>